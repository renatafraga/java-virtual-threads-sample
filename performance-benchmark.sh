#!/bin/bash

# =============================================================================
# Performance Benchmark - Virtual Threads vs Spring WebFlux - FIXED VERSION
# Executa todos os profiles e gera relat√≥rio completo de performance
# =============================================================================

set -e  # Para no primeiro erro

# Cores para output - Paleta moderna e elegante
RED='\033[0;31m'           # Vermelho para erros
EMERALD='\033[38;5;46m'    # Verde esmeralda em vez do verde padr√£o
AMBER='\033[38;5;214m'     # √Çmbar em vez do amarelo
BLUE='\033[0;34m'          # Azul padr√£o
PURPLE='\033[0;35m'        # Roxo padr√£o
CYAN='\033[0;36m'          # Ciano padr√£o
SILVER='\033[38;5;245m'    # Prata para informa√ß√µes secund√°rias
LIME='\033[38;5;154m'      # Verde lima para sucessos
ORANGE='\033[38;5;208m'    # Laranja para warnings
TEAL='\033[38;5;30m'       # Verde azulado
NC='\033[0m'               # No Color

# Configura√ß√µes (podem ser sobrescritas por vari√°veis de ambiente)
PORT=${PORT:-8080}
WARMUP_REQUESTS=${WARMUP_REQUESTS:-5}
TEST_REQUESTS=${TEST_REQUESTS:-20}
CONCURRENT_REQUESTS=${CONCURRENT_REQUESTS:-100}
RESULTS_FILE="performance-report-$(date +%Y%m%d-%H%M%S).txt"

echo -e "${BLUE}üöÄ BENCHMARK DE PERFORMANCE - VIRTUAL THREADS${NC}"
echo "=============================================================="
echo "üìÖ Data: $(date)"
echo "‚öôÔ∏è  Configura√ß√£o:"
echo "   - Warmup requests: $WARMUP_REQUESTS"
echo "   - Test requests: $TEST_REQUESTS"
echo "   - Concurrent requests: $CONCURRENT_REQUESTS"
echo "   - Relat√≥rio ser√° salvo em: $RESULTS_FILE"
echo ""

# Fun√ß√£o para obter timestamp preciso (compat√≠vel com macOS e Linux)
get_timestamp_ms() {
    if [[ "$OSTYPE" == "darwin"* ]] && command -v gdate &> /dev/null; then
        # macOS com GNU coreutils
        gdate +%s%3N
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS sem GNU coreutils - usar python como fallback
        python3 -c "import time; print(int(time.time() * 1000))"
    else
        # Linux
        date +%s%3N
    fi
}

# Verificar depend√™ncias
check_dependencies() {
    echo -e "${CYAN}üîç Verificando depend√™ncias...${NC}"
    
    if ! command -v curl &> /dev/null; then
        echo -e "${RED}‚ùå curl n√£o encontrado${NC}"
        exit 1
    fi
    
    if ! command -v jq &> /dev/null; then
        echo -e "${ORANGE}‚ö†Ô∏è  jq n√£o encontrado. Instalando...${NC}"
        if command -v brew &> /dev/null; then
            brew install jq
        else
            echo -e "${RED}‚ùå Por favor, instale jq manualmente${NC}"
            exit 1
        fi
    fi
    
    if ! command -v bc &> /dev/null; then
        echo -e "${ORANGE}‚ö†Ô∏è  bc (calculadora) n√£o encontrado. Instalando...${NC}"
        if command -v brew &> /dev/null; then
            brew install bc
        else
            echo -e "${RED}‚ùå Por favor, instale bc manualmente: brew install bc${NC}"
            exit 1
        fi
    fi
    
    # Verificar se temos gdate (GNU date) para timestamps precisos no macOS
    if [[ "$OSTYPE" == "darwin"* ]] && ! command -v gdate &> /dev/null; then
        echo -e "${ORANGE}‚ö†Ô∏è  gdate n√£o encontrado. Instalando coreutils para timestamps precisos...${NC}"
        if command -v brew &> /dev/null; then
            brew install coreutils
        else
            echo -e "${ORANGE}‚ö†Ô∏è  Sem coreutils, usando Python para timestamps${NC}"
        fi
    fi
    
    echo -e "${EMERALD}‚úÖ Depend√™ncias verificadas${NC}"
}

# Compilar projeto se necess√°rio
build_project() {
    if [ ! -f "build/libs/java-virtual-threads-sample-0.0.1-SNAPSHOT.jar" ]; then
        echo -e "${AMBER}üî® Compilando projeto...${NC}"
        ./gradlew clean build -x test
        if [ $? -ne 0 ]; then
            echo -e "${RED}üí• Erro na compila√ß√£o!${NC}"
            exit 1
        fi
        echo -e "${EMERALD}‚úÖ Projeto compilado${NC}"
    else
        echo -e "${EMERALD}‚úÖ JAR j√° existe${NC}"
    fi
}

# Aguardar aplica√ß√£o estar pronta
wait_for_app() {
    local max_attempts=30
    local attempt=1
    
    echo -e "${SILVER}‚è≥ Aguardando aplica√ß√£o inicializar...${NC}" >&2
    while [ $attempt -le $max_attempts ]; do
        if curl -s http://localhost:$PORT/api/ > /dev/null 2>&1; then
            return 0
        fi
        echo -n "." >&2
        sleep 1
        ((attempt++))
    done
    
    echo -e "${RED}‚ùå Timeout aguardando aplica√ß√£o${NC}" >&2
    return 1
}

# Fazer warmup da JVM
warmup_jvm() {
    local endpoint=$1
    echo -e "${ORANGE}üî• Fazendo warmup da JVM...${NC}" >&2
    for i in $(seq 1 $WARMUP_REQUESTS); do
        curl -s "$endpoint" > /dev/null 2>&1 || true
        echo -n "." >&2
    done
    echo -e "${LIME} ‚úÖ Warmup conclu√≠do${NC}" >&2
}

# Executar teste de performance
run_performance_test() {
    local test_name=$1
    local endpoint=$2
    local description=$3
    
    echo -e "${CYAN}üß™ Testando: $test_name${NC}" >&2
    echo "   Endpoint: $endpoint" >&2
    echo "   Descri√ß√£o: $description" >&2
    
    # Fazer warmup primeiro
    warmup_jvm "$endpoint"
    
    # Arrays para armazenar resultados
    local times=()
    local thread_infos=()
    
    echo -e "${SILVER}üìä Executando $TEST_REQUESTS requisi√ß√µes...${NC}" >&2
    
    for i in $(seq 1 $TEST_REQUESTS); do
        local start_time=$(get_timestamp_ms)
        
        # Fazer a requisi√ß√£o e capturar resposta
        local response=$(curl -s "$endpoint" 2>/dev/null)
        
        local end_time=$(get_timestamp_ms)
        local total_time=$((end_time - start_time))
        
        # Verificar se temos resposta v√°lida
        if [ ! -z "$response" ]; then
            # Extrair informa√ß√µes da resposta se poss√≠vel
            local thread_info=$(echo "$response" | jq -r '.threadInfo // .initialThreadInfo // "N/A"' 2>/dev/null || echo "N/A")
            
            times+=($total_time)
            thread_infos+=("$thread_info")
        else
            echo -n "E" >&2 # Erro
            times+=(0)
            thread_infos+=("ERROR")
        fi
        
        echo -n "." >&2
    done
    
    echo "" >&2
    
    # Calcular estat√≠sticas
    local sum=0
    local min=999999
    local max=0
    local valid_count=0
    
    for time in "${times[@]}"; do
        if [ "$time" -gt 0 ] 2>/dev/null; then
            sum=$((sum + time))
            if [ $time -lt $min ]; then min=$time; fi
            if [ $time -gt $max ]; then max=$time; fi
            ((valid_count++))
        fi
    done
    
    if [ $valid_count -eq 0 ]; then
        echo -e "${RED}‚ùå Nenhum tempo v√°lido coletado${NC}" >&2
        echo "0:0:0:0:ERROR"
        return
    fi
    
    local avg=$((sum / valid_count))
    
    # Salvar resultados
    echo "----------------------------------------" >> "$RESULTS_FILE"
    echo "TESTE: $test_name" >> "$RESULTS_FILE"
    echo "Endpoint: $endpoint" >> "$RESULTS_FILE"
    echo "Descri√ß√£o: $description" >> "$RESULTS_FILE"
    echo "Data/Hora: $(date)" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "RESULTADOS:" >> "$RESULTS_FILE"
    echo "- Requisi√ß√µes v√°lidas: $valid_count/${#times[@]}" >> "$RESULTS_FILE"
    echo "- Tempo m√©dio: ${avg}ms" >> "$RESULTS_FILE"
    echo "- Tempo m√≠nimo: ${min}ms" >> "$RESULTS_FILE"
    echo "- Tempo m√°ximo: ${max}ms" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    # Mostrar resumo na tela
    echo -e "${LIME}üìà Resultados:${NC}" >&2
    echo "   ‚Ä¢ Requisi√ß√µes v√°lidas: $valid_count/${#times[@]}" >&2
    echo "   ‚Ä¢ Tempo m√©dio: ${avg}ms" >&2
    echo "   ‚Ä¢ Tempo m√≠nimo: ${min}ms" >&2
    echo "   ‚Ä¢ Tempo m√°ximo: ${max}ms" >&2
    echo "   ‚Ä¢ Thread info (primeira req): ${thread_infos[0]}" >&2
    echo "" >&2
    
    # Retornar valores para compara√ß√£o global
    echo "$avg:$min:$max:$valid_count:${thread_infos[0]}"
}

# Teste de carga concorrente
run_concurrent_test() {
    local test_name=$1
    local endpoint=$2
    
    echo -e "${PURPLE}‚ö° Teste de Carga Concorrente: $test_name${NC}" >&2
    echo "   Endpoint: $endpoint" >&2
    echo "   Requisi√ß√µes simult√¢neas: $CONCURRENT_REQUESTS" >&2
    
    local start_time=$(get_timestamp_ms)
    
    # Executar requisi√ß√µes em paralelo
    for i in $(seq 1 $CONCURRENT_REQUESTS); do
        curl -s "$endpoint" > /dev/null 2>&1 &
    done
    
    # Aguardar todas as requisi√ß√µes terminarem
    wait
    
    local end_time=$(get_timestamp_ms)
    local total_time=$((end_time - start_time))
    
    echo -e "${TEAL}üìä Teste de carga conclu√≠do em: ${total_time}ms${NC}" >&2
    
    if [ "$total_time" -gt 0 ]; then
        local rps=$(echo "scale=2; $CONCURRENT_REQUESTS * 1000 / $total_time" | bc 2>/dev/null || echo "N/A")
        echo "   ‚Ä¢ Requisi√ß√µes por segundo: $rps" >&2
    else
        echo "   ‚Ä¢ Requisi√ß√µes por segundo: N/A (tempo inv√°lido)" >&2
        local rps="N/A"
    fi
    
    # Salvar no relat√≥rio
    echo "TESTE DE CARGA CONCORRENTE: $test_name" >> "$RESULTS_FILE"
    echo "- Requisi√ß√µes simult√¢neas: $CONCURRENT_REQUESTS" >> "$RESULTS_FILE"
    echo "- Tempo total: ${total_time}ms" >> "$RESULTS_FILE"
    echo "- Requisi√ß√µes por segundo: $rps" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    echo "$total_time"
}

# Iniciar aplica√ß√£o com profile espec√≠fico
start_application() {
    local profile=$1
    local profile_name=$2
    
    echo -e "${BLUE}üöÄ Iniciando aplica√ß√£o: $profile_name${NC}" >&2
    echo "   Profile: $profile" >&2
    
    # Matar processos existentes
    pkill -f "java-virtual-threads-sample" 2>/dev/null || true
    sleep 2
    
    # Iniciar nova aplica√ß√£o
    java -jar build/libs/java-virtual-threads-sample-0.0.1-SNAPSHOT.jar \
        --spring.profiles.active="$profile" \
        --server.port=$PORT \
        --logging.level.root=WARN \
        > /tmp/app-$profile.log 2>&1 &
    
    local pid=$!
    echo "   PID: $pid" >&2
    
    if ! wait_for_app; then
        echo -e "${RED}‚ùå Falha ao iniciar aplica√ß√£o${NC}" >&2
        kill $pid 2>/dev/null || true
        return 1
    fi
    
    return 0
}

# Parar aplica√ß√£o
stop_application() {
    echo -e "${ORANGE}üõë Parando aplica√ß√£o...${NC}" >&2
    pkill -f "java-virtual-threads-sample" 2>/dev/null || true
    sleep 2
    echo -e "${EMERALD}‚úÖ Aplica√ß√£o parada${NC}" >&2
}

# Fun√ß√£o de teste r√°pido
quick_test() {
    echo -e "${CYAN}üß™ Teste R√°pido de Funcionalidade${NC}"
    
    check_dependencies
    build_project
    
    # Testar apenas um profile
    if start_application "mvc-traditional" "Spring MVC Tradicional"; then
        run_performance_test \
            "MVC Quick Test" \
            "http://localhost:$PORT/api/mvc/persons/blocking?count=5" \
            "Teste r√°pido do MVC blocking"
        
        stop_application
        echo -e "${EMERALD}‚úÖ Teste r√°pido conclu√≠do com sucesso!${NC}"
    else
        echo -e "${RED}‚ùå Falha no teste r√°pido${NC}"
        return 1
    fi
}

# Testar um endpoint espec√≠fico
test_single_endpoint() {
    local profile=$1
    local profile_name=$2
    local endpoint_path=$3
    local test_description=$4
    
    echo "" >&2
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}" >&2
    echo -e "${BLUE}üéØ TESTANDO: $profile_name${NC}" >&2
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}" >&2
    echo "" >&2
    
    # Iniciar aplica√ß√£o
    if ! start_application "$profile" "$profile_name"; then
        echo -e "${RED}‚ùå Falha ao iniciar aplica√ß√£o para o profile $profile${NC}" >&2
        return 1
    fi
    
    # Salvar cabe√ßalho no relat√≥rio
    echo "===============================================" >> "$RESULTS_FILE"
    echo "TESTE: $profile_name ($profile)" >> "$RESULTS_FILE"
    echo "Descri√ß√£o: $test_description" >> "$RESULTS_FILE"
    echo "===============================================" >> "$RESULTS_FILE"
    
    # Executar teste do endpoint (redirecionar sa√≠da visual para stderr)
    local test_result=$(run_performance_test \
        "$profile_name" \
        "http://localhost:$PORT$endpoint_path" \
        "$test_description" 2>&2)
    
    # Teste de carga concorrente
    echo -e "${PURPLE}‚ö° Teste de Carga Concorrente...${NC}" >&2
    local concurrent_result=$(run_concurrent_test \
        "$profile_name" \
        "http://localhost:$PORT$endpoint_path" 2>&2)
    
    # Parar aplica√ß√£o
    stop_application
    
    # Retornar resultado (formato: test_result|concurrent_result)
    echo "$test_result|$concurrent_result"
}

# Gerar relat√≥rio de compara√ß√£o
generate_comparison_report() {
    local mvc_traditional_results=$1
    local mvc_virtual_results=$2
    local webflux_traditional_results=$3
    local webflux_virtual_results=$4
    
    echo "" >> "$RESULTS_FILE"
    echo "===============================================" >> "$RESULTS_FILE"
    echo "RELAT√ìRIO DE COMPARA√á√ÉO FINAL" >> "$RESULTS_FILE"
    echo "===============================================" >> "$RESULTS_FILE"
    echo "Gerado em: $(date)" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    # Verificar se temos resultados v√°lidos
    if [[ -z "$mvc_traditional_results" || -z "$mvc_virtual_results" ]]; then
        echo "‚ö†Ô∏è  Alguns testes falharam - relat√≥rio de compara√ß√£o incompleto" >> "$RESULTS_FILE"
        return
    fi
    
    # Extrair m√©dias para compara√ß√£o (primeiro valor antes do :)
    IFS='|' read -ra mvc_trad <<< "$mvc_traditional_results"
    IFS='|' read -ra mvc_virt <<< "$mvc_virtual_results"
    
    echo "COMPARA√á√ÉO - SPRING MVC:" >> "$RESULTS_FILE"
    echo "==========================================" >> "$RESULTS_FILE"
    
    # MVC Blocking
    local mvc_trad_blocking_avg=$(echo "${mvc_trad[0]}" | cut -d':' -f1)
    local mvc_virt_blocking_avg=$(echo "${mvc_virt[0]}" | cut -d':' -f1)
    echo "MVC BLOCKING:" >> "$RESULTS_FILE"
    echo "- Tradicional: ${mvc_trad_blocking_avg}ms (avg)" >> "$RESULTS_FILE"
    echo "- Virtual:     ${mvc_virt_blocking_avg}ms (avg)" >> "$RESULTS_FILE"
    
    # Calcular melhoria se poss√≠vel
    if [[ "$mvc_trad_blocking_avg" != "0" && "$mvc_virt_blocking_avg" != "0" ]]; then
        local improvement=$(echo "scale=2; (($mvc_trad_blocking_avg - $mvc_virt_blocking_avg) / $mvc_trad_blocking_avg) * 100" | bc 2>/dev/null || echo "N/A")
        echo "- Melhoria: ${improvement}%" >> "$RESULTS_FILE"
    fi
    echo "" >> "$RESULTS_FILE"
    
    # MVC Async
    local mvc_trad_async_avg=$(echo "${mvc_trad[1]}" | cut -d':' -f1)
    local mvc_virt_async_avg=$(echo "${mvc_virt[1]}" | cut -d':' -f1)
    echo "MVC ASYNC:" >> "$RESULTS_FILE"
    echo "- Tradicional: ${mvc_trad_async_avg}ms (avg)" >> "$RESULTS_FILE"
    echo "- Virtual:     ${mvc_virt_async_avg}ms (avg)" >> "$RESULTS_FILE"
    
    if [[ "$mvc_trad_async_avg" != "0" && "$mvc_virt_async_avg" != "0" ]]; then
        local improvement=$(echo "scale=2; (($mvc_trad_async_avg - $mvc_virt_async_avg) / $mvc_trad_async_avg) * 100" | bc 2>/dev/null || echo "N/A")
        echo "- Melhoria: ${improvement}%" >> "$RESULTS_FILE"
    fi
    echo "" >> "$RESULTS_FILE"
    
    # WebFlux se dispon√≠vel
    if [[ ! -z "$webflux_traditional_results" && ! -z "$webflux_virtual_results" ]]; then
        IFS='|' read -ra webflux_trad <<< "$webflux_traditional_results"
        IFS='|' read -ra webflux_virt <<< "$webflux_virtual_results"
        
        echo "COMPARA√á√ÉO - SPRING WEBFLUX:" >> "$RESULTS_FILE"
        echo "==========================================" >> "$RESULTS_FILE"
        
        local webflux_trad_list_avg=$(echo "${webflux_trad[3]}" | cut -d':' -f1)
        local webflux_virt_list_avg=$(echo "${webflux_virt[3]}" | cut -d':' -f1)
        echo "WEBFLUX LIST:" >> "$RESULTS_FILE"
        echo "- Tradicional: ${webflux_trad_list_avg}ms (avg)" >> "$RESULTS_FILE"
        echo "- Virtual:     ${webflux_virt_list_avg}ms (avg)" >> "$RESULTS_FILE"
        
        if [[ "$webflux_trad_list_avg" != "0" && "$webflux_virt_list_avg" != "0" ]]; then
            local improvement=$(echo "scale=2; (($webflux_trad_list_avg - $webflux_virt_list_avg) / $webflux_trad_list_avg) * 100" | bc 2>/dev/null || echo "N/A")
            echo "- Melhoria: ${improvement}%" >> "$RESULTS_FILE"
        fi
        echo "" >> "$RESULTS_FILE"
    fi
    
    # Testes de carga
    echo "COMPARA√á√ÉO - TESTES DE CARGA:" >> "$RESULTS_FILE"
    echo "==========================================" >> "$RESULTS_FILE"
    echo "CARGA CONCORRENTE (MVC Blocking):" >> "$RESULTS_FILE"
    echo "- Tradicional: ${mvc_trad[5]}ms total" >> "$RESULTS_FILE"
    echo "- Virtual:     ${mvc_virt[5]}ms total" >> "$RESULTS_FILE"
    
    if [[ ! -z "$webflux_traditional_results" && ! -z "$webflux_virtual_results" ]]; then
        echo "CARGA CONCORRENTE (WebFlux List):" >> "$RESULTS_FILE"
        echo "- Tradicional: ${webflux_trad[6]}ms total" >> "$RESULTS_FILE"
        echo "- Virtual:     ${webflux_virt[6]}ms total" >> "$RESULTS_FILE"
    fi
    echo "" >> "$RESULTS_FILE"
}

# Gerar relat√≥rio de compara√ß√£o simplificado
generate_simple_comparison_report() {
    local mvc_traditional=$1
    local mvc_virtual=$2
    local webflux_traditional=$3
    local webflux_virtual=$4
    
    echo "" >> "$RESULTS_FILE"
    echo "===============================================" >> "$RESULTS_FILE"
    echo "COMPARA√á√ÉO FINAL - VIRTUAL THREADS vs TRADICIONAL" >> "$RESULTS_FILE"
    echo "===============================================" >> "$RESULTS_FILE"
    echo "Gerado em: $(date)" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    # Extrair dados dos resultados (formato: avg:min:max:count:thread_info|concurrent_time)
    if [[ ! -z "$mvc_traditional" && ! -z "$mvc_virtual" ]]; then
        IFS='|' read -ra mvc_trad <<< "$mvc_traditional"
        IFS='|' read -ra mvc_virt <<< "$mvc_virtual"
        
        local mvc_trad_avg=$(echo "${mvc_trad[0]}" | cut -d':' -f1)
        local mvc_virt_avg=$(echo "${mvc_virt[0]}" | cut -d':' -f1)
        local mvc_trad_concurrent=${mvc_trad[1]}
        local mvc_virt_concurrent=${mvc_virt[1]}
        
        echo "üîπ SPRING MVC COMPARISON:" >> "$RESULTS_FILE"
        echo "  Tempo M√©dio:" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Sem Virtual Threads: ${mvc_trad_avg}ms" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Com Virtual Threads: ${mvc_virt_avg}ms" >> "$RESULTS_FILE"
        
        if [[ "$mvc_trad_avg" != "0" && "$mvc_virt_avg" != "0" ]]; then
            local improvement=$(echo "scale=1; (($mvc_trad_avg - $mvc_virt_avg) / $mvc_trad_avg) * 100" | bc 2>/dev/null || echo "N/A")
            echo "    ‚Ä¢ Melhoria: ${improvement}%" >> "$RESULTS_FILE"
        fi
        
        echo "  Teste de Carga ($CONCURRENT_REQUESTS requisi√ß√µes):" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Sem Virtual Threads: ${mvc_trad_concurrent}ms total" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Com Virtual Threads: ${mvc_virt_concurrent}ms total" >> "$RESULTS_FILE"
        echo "" >> "$RESULTS_FILE"
    fi
    
    if [[ ! -z "$webflux_traditional" && ! -z "$webflux_virtual" ]]; then
        IFS='|' read -ra flux_trad <<< "$webflux_traditional"
        IFS='|' read -ra flux_virt <<< "$webflux_virtual"
        
        local flux_trad_avg=$(echo "${flux_trad[0]}" | cut -d':' -f1)
        local flux_virt_avg=$(echo "${flux_virt[0]}" | cut -d':' -f1)
        local flux_trad_concurrent=${flux_trad[1]}
        local flux_virt_concurrent=${flux_virt[1]}
        
        echo "üîπ SPRING WEBFLUX COMPARISON:" >> "$RESULTS_FILE"
        echo "  Tempo M√©dio:" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Sem Virtual Threads: ${flux_trad_avg}ms" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Com Virtual Threads: ${flux_virt_avg}ms" >> "$RESULTS_FILE"
        
        if [[ "$flux_trad_avg" != "0" && "$flux_virt_avg" != "0" ]]; then
            local improvement=$(echo "scale=1; (($flux_trad_avg - $flux_virt_avg) / $flux_trad_avg) * 100" | bc 2>/dev/null || echo "N/A")
            echo "    ‚Ä¢ Melhoria: ${improvement}%" >> "$RESULTS_FILE"
        fi
        
        echo "  Teste de Carga ($CONCURRENT_REQUESTS requisi√ß√µes):" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Sem Virtual Threads: ${flux_trad_concurrent}ms total" >> "$RESULTS_FILE"
        echo "    ‚Ä¢ Com Virtual Threads: ${flux_virt_concurrent}ms total" >> "$RESULTS_FILE"
        echo "" >> "$RESULTS_FILE"
    fi
    
    # Resumo geral
    echo "üéØ RESUMO EXECUTIVO:" >> "$RESULTS_FILE"
    echo "  Virtual Threads s√£o mais eficazes quando:" >> "$RESULTS_FILE"
    echo "  ‚Ä¢ H√° opera√ß√µes I/O intensivas (database, network)" >> "$RESULTS_FILE"
    echo "  ‚Ä¢ Muitas threads concorrentes s√£o necess√°rias" >> "$RESULTS_FILE"
    echo "  ‚Ä¢ O pool de threads tradicionais √© limitado" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "  Virtual Threads podem ter overhead quando:" >> "$RESULTS_FILE"
    echo "  ‚Ä¢ Opera√ß√µes s√£o CPU-intensivas" >> "$RESULTS_FILE"
    echo "  ‚Ä¢ Poucas threads s√£o necess√°rias" >> "$RESULTS_FILE"
    echo "  ‚Ä¢ Opera√ß√µes s√£o muito r√°pidas" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    # Adicionar an√°lise t√©cnica detalhada
    add_technical_analysis "$mvc_traditional" "$mvc_virtual" "$webflux_traditional" "$webflux_virtual"
}

# Adicionar an√°lise t√©cnica detalhada ao relat√≥rio
add_technical_analysis() {
    local mvc_traditional=$1
    local mvc_virtual=$2
    local webflux_traditional=$3
    local webflux_virtual=$4
    
    echo "===============================================" >> "$RESULTS_FILE"
    echo "üß¨ AN√ÅLISE T√âCNICA: ARQUITETURA CONFLITANTE" >> "$RESULTS_FILE"
    echo "===============================================" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    # Calcular melhorias/degrada√ß√µes
    local mvc_improvement="N/A"
    local webflux_improvement="N/A"
    
    if [[ ! -z "$mvc_traditional" && ! -z "$mvc_virtual" ]]; then
        IFS='|' read -ra mvc_trad <<< "$mvc_traditional"
        IFS='|' read -ra mvc_virt <<< "$mvc_virtual"
        local mvc_trad_concurrent=${mvc_trad[1]}
        local mvc_virt_concurrent=${mvc_virt[1]}
        
        if [[ "$mvc_trad_concurrent" != "0" && "$mvc_virt_concurrent" != "0" ]]; then
            mvc_improvement=$(echo "scale=1; (($mvc_trad_concurrent - $mvc_virt_concurrent) / $mvc_trad_concurrent) * 100" | bc 2>/dev/null || echo "N/A")
        fi
    fi
    
    if [[ ! -z "$webflux_traditional" && ! -z "$webflux_virtual" ]]; then
        IFS='|' read -ra flux_trad <<< "$webflux_traditional"
        IFS='|' read -ra flux_virt <<< "$webflux_virtual"
        local flux_trad_concurrent=${flux_trad[1]}
        local flux_virt_concurrent=${flux_virt[1]}
        
        if [[ "$flux_trad_concurrent" != "0" && "$flux_virt_concurrent" != "0" ]]; then
            webflux_improvement=$(echo "scale=1; (($flux_trad_concurrent - $flux_virt_concurrent) / $flux_trad_concurrent) * 100" | bc 2>/dev/null || echo "N/A")
        fi
    fi
    
    echo "üéØ RESULTADOS OBSERVADOS:" >> "$RESULTS_FILE"
    echo "Hardware: $(system_profiler SPHardwareDataType 2>/dev/null | grep 'Chip:' | head -1 | sed 's/.*: //' || echo 'N/A')" >> "$RESULTS_FILE"
    echo "Cores: $(system_profiler SPHardwareDataType 2>/dev/null | grep 'Total Number of Cores:' | head -1 | sed 's/.*: //' || sysctl -n hw.ncpu 2>/dev/null || echo 'N/A')" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "Spring MVC + Virtual Threads: ${mvc_improvement}% melhoria" >> "$RESULTS_FILE"
    echo "Spring WebFlux + Virtual Threads: ${webflux_improvement}% melhoria" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    echo "üèóÔ∏è POR QUE SPRING MVC + VIRTUAL THREADS √â EXCELENTE:" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "‚îå‚îÄ Spring MVC Tradicional ‚îÄ‚îê    ‚îå‚îÄ Spring MVC + Virtual Threads ‚îÄ‚îê" >> "$RESULTS_FILE"
    echo "‚îÇ Thread Pool (200 threads) ‚îÇ    ‚îÇ Virtual Threads (1000+ ilimitadas) ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îÇ T1  ‚îÇ ‚îÇ T2  ‚îÇ ‚îÇ...  ‚îÇ  ‚îÇ    ‚îÇ ‚îÇ VT1 ‚îÇ ‚îÇ VT2 ‚îÇ ‚îÇ...  ‚îÇ ‚îÇ1000+‚îÇ ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îÇBLOCK‚îÇ ‚îÇBLOCK‚îÇ ‚îÇBLOCK‚îÇ  ‚îÇ    ‚îÇ ‚îÇSUSP ‚îÇ ‚îÇSUSP ‚îÇ ‚îÇSUSP ‚îÇ ‚îÇSUSP ‚îÇ ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" >> "$RESULTS_FILE"
    echo "‚ùå Threads bloqueadas em I/O    ‚úÖ VT suspensas, carrier threads livres" >> "$RESULTS_FILE"
    echo "‚ùå Pool limitado = gargalo      ‚úÖ Scaling ilimitado" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    echo "‚ö†Ô∏è POR QUE WEBFLUX + VIRTUAL THREADS PODE SER PROBLEM√ÅTICO:" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "‚îå‚îÄ WebFlux Tradicional ‚îÄ‚îê    ‚îå‚îÄ WebFlux + Virtual Threads ‚îÄ‚îê" >> "$RESULTS_FILE"
    echo "‚îÇ Event Loop (otimizado) ‚îÇ    ‚îÇ Event Loop + VT (competi√ß√£o) ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îÇ EL1 ‚îÇ ‚îÇ EL2 ‚îÇ       ‚îÇ    ‚îÇ ‚îÇ EL1 ‚îÇ ‚îÇ VT1 ‚îÇ ‚îÇ VT2 ‚îÇ      ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îÇNonBl‚îÇ ‚îÇNonBl‚îÇ       ‚îÇ    ‚îÇ ‚îÇComp ‚îÇ ‚îÇComp ‚îÇ ‚îÇComp ‚îÇ      ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" >> "$RESULTS_FILE"
    echo "‚úÖ Non-blocking nativo        ‚ùå Scheduler competition" >> "$RESULTS_FILE"
    echo "‚úÖ Resource efficient         ‚ùå Context switching overhead" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    echo "üî¨ AN√ÅLISE ESPEC√çFICA DO SISTEMA:" >> "$RESULTS_FILE"
    echo "‚Ä¢ Arquitetura ARM64 (Apple Silicon) favorece thread pools pequenos" >> "$RESULTS_FILE"
    echo "‚Ä¢ Context switching entre Virtual Threads e Reactor tem penalty" >> "$RESULTS_FILE"
    echo "‚Ä¢ Scheduler coordination adds overhead in reactive chains" >> "$RESULTS_FILE"
    echo "‚Ä¢ Memory allocation patterns differ between approaches" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    echo "üí° DECIS√ÉO ARQUITETURAL:" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "‚îå‚îÄ Workload Type ‚îÄ‚î¨‚îÄ Tecnologia Recomendada ‚îÄ‚î¨‚îÄ Justificativa ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" >> "$RESULTS_FILE"
    echo "‚îÇ Blocking I/O    ‚îÇ Spring MVC + Virtual     ‚îÇ 85%+ performance gain   ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ High Concurr.   ‚îÇ Threads                  ‚îÇ Unlimited scaling       ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" >> "$RESULTS_FILE"
    echo "‚îÇ Non-blocking    ‚îÇ Spring WebFlux           ‚îÇ Already optimized       ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ Event-driven    ‚îÇ Traditional              ‚îÇ No VT overhead          ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" >> "$RESULTS_FILE"
    echo "‚îÇ CPU Intensive   ‚îÇ Traditional Threads      ‚îÇ Avoid over-subscription ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îÇ Low Concurrency ‚îÇ (any framework)          ‚îÇ VT overhead not worth   ‚îÇ" >> "$RESULTS_FILE"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    echo "üìö CONCLUS√ÉO:" >> "$RESULTS_FILE"
    echo "Virtual Threads s√£o uma revolu√ß√£o para aplica√ß√µes blocking," >> "$RESULTS_FILE"
    echo "mas podem interferir negativamente em arquiteturas j√° otimizadas." >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "Regra de ouro: Blocking I/O ‚Üí Virtual Threads | Non-blocking I/O ‚Üí Reactive" >> "$RESULTS_FILE"
    echo "Esta an√°lise demonstra que mais tecnologia nem sempre √© melhor!" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
}
}

# Mostrar resumo simples na tela
show_simple_summary() {
    local mvc_traditional=$1
    local mvc_virtual=$2
    local webflux_traditional=$3
    local webflux_virtual=$4
    
    echo -e "${CYAN}üìà RESUMO DOS RESULTADOS:${NC}"
    echo ""
    
    if [[ ! -z "$mvc_traditional" && ! -z "$mvc_virtual" ]]; then
        IFS='|' read -ra mvc_trad <<< "$mvc_traditional"
        IFS='|' read -ra mvc_virt <<< "$mvc_virtual"
        
        local mvc_trad_avg=$(echo "${mvc_trad[0]}" | cut -d':' -f1)
        local mvc_virt_avg=$(echo "${mvc_virt[0]}" | cut -d':' -f1)
        
        echo -e "${BLUE}üîπ Spring MVC:${NC}"
        echo "   ‚Ä¢ Sem Virtual Threads: ${mvc_trad_avg}ms"
        echo "   ‚Ä¢ Com Virtual Threads: ${mvc_virt_avg}ms"
        
        if [[ "$mvc_trad_avg" != "0" && "$mvc_virt_avg" != "0" ]]; then
            local improvement=$(echo "scale=1; (($mvc_trad_avg - $mvc_virt_avg) / $mvc_trad_avg) * 100" | bc 2>/dev/null || echo "N/A")
            if [[ "$improvement" != "N/A" ]]; then
                if (( $(echo "$improvement > 0" | bc -l) )); then
                    echo -e "   ‚Ä¢ ${EMERALD}Melhoria: ${improvement}%${NC} ‚úÖ"
                else
                    echo -e "   ‚Ä¢ ${AMBER}Diferen√ßa: ${improvement}%${NC} ‚ö†Ô∏è"
                fi
            fi
        fi
        echo ""
    fi
    
    if [[ ! -z "$webflux_traditional" && ! -z "$webflux_virtual" ]]; then
        IFS='|' read -ra flux_trad <<< "$webflux_traditional"
        IFS='|' read -ra flux_virt <<< "$webflux_virtual"
        
        local flux_trad_avg=$(echo "${flux_trad[0]}" | cut -d':' -f1)
        local flux_virt_avg=$(echo "${flux_virt[0]}" | cut -d':' -f1)
        
        echo -e "${BLUE}üîπ Spring WebFlux:${NC}"
        echo "   ‚Ä¢ Sem Virtual Threads: ${flux_trad_avg}ms"
        echo "   ‚Ä¢ Com Virtual Threads: ${flux_virt_avg}ms"
        
        if [[ "$flux_trad_avg" != "0" && "$flux_virt_avg" != "0" ]]; then
            local improvement=$(echo "scale=1; (($flux_trad_avg - $flux_virt_avg) / $flux_trad_avg) * 100" | bc 2>/dev/null || echo "N/A")
            if [[ "$improvement" != "N/A" ]]; then
                if (( $(echo "$improvement > 0" | bc -l) )); then
                    echo -e "   ‚Ä¢ ${EMERALD}Melhoria: ${improvement}%${NC} ‚úÖ"
                else
                    echo -e "   ‚Ä¢ ${AMBER}Diferen√ßa: ${improvement}%${NC} ‚ö†Ô∏è"
                fi
            fi
        fi
        echo ""
    fi
    
    echo -e "${SILVER}üí° Dica: Veja o relat√≥rio completo em $RESULTS_FILE${NC}"
}

# Executar benchmark simplificado (4 cen√°rios principais)
run_simple_benchmark() {
    echo -e "${TEAL}üöÄ Benchmark Simples - 4 Cen√°rios Principais${NC}"
    echo ""
    
    # Prepara√ß√£o
    check_dependencies
    build_project
    
    # Inicializar arquivo de relat√≥rio
    echo "RELAT√ìRIO DE PERFORMANCE - VIRTUAL THREADS COMPARISON" > "$RESULTS_FILE"
    echo "====================================================" >> "$RESULTS_FILE"
    echo "Data: $(date)" >> "$RESULTS_FILE"
    echo "Sistema: $(uname -a)" >> "$RESULTS_FILE"
    echo "Java Version: $(java -version 2>&1 | head -1)" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "CONFIGURA√á√ÉO DOS TESTES:" >> "$RESULTS_FILE"
    echo "- Warmup requests: $WARMUP_REQUESTS" >> "$RESULTS_FILE"
    echo "- Test requests: $TEST_REQUESTS" >> "$RESULTS_FILE"
    echo "- Concurrent requests: $CONCURRENT_REQUESTS" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    echo "CEN√ÅRIOS TESTADOS:" >> "$RESULTS_FILE"
    echo "1. Spring MVC sem Virtual Threads" >> "$RESULTS_FILE"
    echo "2. Spring MVC com Virtual Threads" >> "$RESULTS_FILE"
    echo "3. Spring WebFlux sem Virtual Threads" >> "$RESULTS_FILE"
    echo "4. Spring WebFlux com Virtual Threads" >> "$RESULTS_FILE"
    echo "" >> "$RESULTS_FILE"
    
    # Vari√°veis para armazenar resultados
    local mvc_traditional=""
    local mvc_virtual=""
    local webflux_traditional=""
    local webflux_virtual=""
    
    # 1. Spring MVC sem Virtual Threads
    echo -e "${BLUE}üìä [1/4] Spring MVC sem Virtual Threads${NC}"
    mvc_traditional=$(test_single_endpoint \
        "mvc-traditional" \
        "Spring MVC (Threads Tradicionais)" \
        "/api/mvc/persons/blocking-intensive?count=10" \
        "Spring MVC com threads tradicionais e I/O intensivo (500ms/request)")
    
    # 2. Spring MVC com Virtual Threads
    echo -e "${BLUE}üìä [2/4] Spring MVC com Virtual Threads${NC}"
    mvc_virtual=$(test_single_endpoint \
        "mvc-virtual" \
        "Spring MVC (Virtual Threads)" \
        "/api/mvc/persons/blocking-intensive?count=10" \
        "Spring MVC com Virtual Threads e I/O intensivo (500ms/request)")
    
    # 3. Spring WebFlux sem Virtual Threads
    echo -e "${BLUE}üìä [3/4] Spring WebFlux sem Virtual Threads${NC}"
    webflux_traditional=$(test_single_endpoint \
        "webflux-traditional" \
        "Spring WebFlux (Threads Tradicionais)" \
        "/api/webflux/persons/list-intensive?count=10" \
        "Spring WebFlux com schedulers tradicionais e I/O intensivo")
    
    # 4. Spring WebFlux com Virtual Threads
    echo -e "${BLUE}üìä [4/4] Spring WebFlux com Virtual Threads${NC}"
    webflux_virtual=$(test_single_endpoint \
        "webflux-virtual" \
        "Spring WebFlux (Virtual Threads)" \
        "/api/webflux/persons/list-intensive?count=10" \
        "Spring WebFlux com Virtual Threads no boundedElastic e I/O intensivo")
    
    # Gerar relat√≥rio de compara√ß√£o simplificado
    generate_simple_comparison_report \
        "$mvc_traditional" \
        "$mvc_virtual" \
        "$webflux_traditional" \
        "$webflux_virtual"
    
    # Exibir resumo simples na tela
    show_simple_summary \
        "$mvc_traditional" \
        "$mvc_virtual" \
        "$webflux_traditional" \
        "$webflux_virtual"
    
    # Exibir resumo final
    echo ""
    echo -e "${EMERALD}‚ú® BENCHMARK CONCLU√çDO!${NC}"
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${AMBER}üìÑ Relat√≥rio salvo em: $RESULTS_FILE${NC}"
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo -e "${SILVER}üí° Dica: Veja o relat√≥rio completo em $RESULTS_FILE${NC}"
}

# Fun√ß√£o principal
main() {
    case "${1:-simple}" in
        "quick"|"test")
            quick_test
            ;;
        "simple"|"")
            run_simple_benchmark
            ;;
        *)
            echo "Uso: $0 [quick|simple]"
            echo "  quick  - Teste r√°pido de funcionalidade"
            echo "  simple - Benchmark dos 4 cen√°rios principais (padr√£o)"
            ;;
    esac
}

# Verificar se √© chamada direta
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
